<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>管理后台</title>
  <link rel="icon" href="/favicon.svg" type="image/svg+xml">
  <link rel="stylesheet" href="/css/base.css">
  <link rel="stylesheet" href="/css/components.css">
  <link rel="stylesheet" href="/css/layout.css">
  <link rel="stylesheet" href="/css/admin.css">
  <script>
    fetch('/api/session', { headers: { 'Cache-Control': 'no-cache' } })
      .then(r => r.ok ? r.json() : Promise.reject())
      .then(s => {
        if (s && s.role === 'admin') return;
        if (s && s.role === 'mailbox') { location.replace('/html/mailbox.html'); return; }
        location.replace('/login.html');
      })
      .catch(() => location.replace('/login.html'));
  </script>
</head>
<body>
  <!-- 顶栏 -->
  <div class="topbar">
    <div class="brand">
      <span class="brand-text">管理后台</span>
    </div>
    <div class="nav-actions">
      <button id="export-mailboxes" class="btn btn-sm btn-primary">导出邮箱</button>
      <a href="/html/mailbox.html" class="btn btn-sm">返回邮箱</a>
      <a href="/html/mailboxes.html" class="btn btn-sm">邮箱管理</a>
      <button id="theme-toggle" class="btn btn-sm">主题</button>
      <button id="logout" class="btn btn-sm">退出</button>
    </div>
  </div>

  <!-- 主布局 -->
  <div class="admin-layout">
    <!-- 左栏：邮箱生成 -->
    <div class="admin-sidebar">
      <!-- 邮箱生成 -->
      <div class="admin-section">
        <div class="section-title">生成邮箱</div>
        <div class="section-body">
          <div class="form-group">
            <label class="form-label">域名</label>
            <select id="domain-select" class="form-input"></select>
          </div>
          <div class="form-group">
            <label class="form-label">长度: <span id="len-val">8</span></label>
            <input id="len-range" type="range" min="6" max="16" value="8" style="width:100%;">
          </div>
          <div style="display:flex;gap:6px;margin-bottom:8px;">
            <button id="gen-random" class="btn btn-primary" style="flex:1;">随机生成</button>
            <button id="gen-name" class="btn" style="flex:1;">随机人名</button>
          </div>
          <div class="form-group">
            <label class="form-label">自定义用户名</label>
            <div style="display:flex;gap:6px;">
              <input id="custom-local" class="form-input" style="flex:1;" placeholder="用户名">
              <button id="gen-custom" class="btn btn-primary">创建</button>
            </div>
          </div>
          <div id="generated-email" class="generated-email hidden">
            <span id="email-text"></span>
            <button id="add-email" class="btn btn-sm btn-primary">添加</button>
          </div>
        </div>
      </div>

      <!-- 活跃邮箱榜 -->
      <div class="admin-section">
        <div class="section-title">活跃邮箱榜</div>
        <div class="section-body">
          <div id="active-mailboxes" class="stats-loading">
            <div class="spinner"></div>
          </div>
        </div>
      </div>

      <!-- 注册审核 -->
      <div class="admin-section">
        <div class="section-title">
          <span>注册审核</span>
          <span id="pending-count-badge" class="badge hidden">0</span>
        </div>
        <div class="section-body">
          <div id="registrations-list" class="stats-loading">
            <div class="spinner"></div>
          </div>
          <div class="section-actions" style="margin-top:12px;">
            <button id="refresh-registrations" class="btn btn-sm" style="width:100%;">刷新列表</button>
          </div>
        </div>
      </div>
    </div>

    <!-- 右栏：统计数据 -->
    <div class="admin-main">
      <!-- 核心指标 -->
      <div class="stats-cards">
        <div class="stat-card">
          <div class="stat-value" id="stat-total-mailboxes">-</div>
          <div class="stat-label">邮箱总数</div>
        </div>
        <div class="stat-card">
          <div class="stat-value" id="stat-total-messages">-</div>
          <div class="stat-label">邮件总数</div>
        </div>
        <div class="stat-card">
          <div class="stat-value" id="stat-today-mailboxes">-</div>
          <div class="stat-label">今日新邮箱</div>
        </div>
        <div class="stat-card">
          <div class="stat-value" id="stat-today-messages">-</div>
          <div class="stat-label">今日新邮件</div>
        </div>
      </div>

      <!-- 详细统计 -->
      <div class="stats-grid">
        <!-- 7天趋势 -->
        <div class="admin-section">
          <div class="section-title">最近7天趋势</div>
          <div class="section-body">
            <div id="trend-chart" class="trend-chart">
              <div class="stats-loading"><div class="spinner"></div></div>
            </div>
          </div>
        </div>

        <!-- 邮件来源TOP10 -->
        <div class="admin-section">
          <div class="section-title">邮件来源 TOP10</div>
          <div class="section-body">
            <div id="source-stats" class="stats-loading">
              <div class="spinner"></div>
            </div>
          </div>
        </div>

        <!-- 域名分布 -->
        <div class="admin-section">
          <div class="section-title">邮箱域名分布</div>
          <div class="section-body">
            <div id="domain-stats" class="stats-loading">
              <div class="spinner"></div>
            </div>
          </div>
        </div>

        <!-- 权限分布 -->
        <div class="admin-section">
          <div class="section-title">邮箱状态分布</div>
          <div class="section-body">
            <div id="permission-stats" class="stats-loading">
              <div class="spinner"></div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Toast -->
  <div id="toast" class="toast"></div>

  <!-- 确认模态框 -->
  <div id="confirm-modal" class="modal">
    <div class="modal-box" style="max-width:320px;">
      <div class="modal-header">
        <span>确认</span>
        <button class="close modal-close">x</button>
      </div>
      <div class="modal-body">
        <div id="confirm-message"></div>
      </div>
      <div class="modal-footer">
        <button class="btn modal-close">取消</button>
        <button id="confirm-ok" class="btn btn-danger">确定</button>
      </div>
    </div>
  </div>

  <!-- 添加邮箱配置模态框 -->
  <div id="add-email-modal" class="modal">
    <div class="modal-box" style="max-width:400px;">
      <div class="modal-header">
        <span>添加邮箱</span>
        <button class="close" id="add-email-close">x</button>
      </div>
      <div class="modal-body">
        <div class="form-group">
          <label class="form-label">邮箱地址</label>
          <div id="add-email-address" style="font-weight:bold;word-break:break-all;padding:8px;background:var(--bg-muted);border-radius:4px;"></div>
        </div>
        <div class="form-group">
          <label class="form-label">密码设置</label>
          <div style="display:flex;gap:8px;margin-bottom:8px;">
            <label style="display:flex;align-items:center;gap:4px;cursor:pointer;">
              <input type="radio" name="password-type" value="default" checked>
              <span>使用默认密码</span>
            </label>
            <label style="display:flex;align-items:center;gap:4px;cursor:pointer;">
              <input type="radio" name="password-type" value="custom">
              <span>自定义密码</span>
            </label>
          </div>
          <div id="custom-password-group" class="hidden">
            <input type="password" id="add-email-password" class="form-input" placeholder="请输入密码（至少6位）" minlength="6">
            <input type="password" id="add-email-password-confirm" class="form-input" placeholder="确认密码" minlength="6" style="margin-top:8px;">
          </div>
          <div class="form-hint" style="margin-top:8px;font-size:12px;color:var(--text-muted);">默认密码为邮箱地址本身</div>
        </div>
        <div class="form-group">
          <label style="display:flex;align-items:center;gap:4px;cursor:pointer;">
            <input type="checkbox" id="add-email-can-login" checked>
            <span>允许邮箱登录</span>
          </label>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn" id="add-email-cancel">取消</button>
        <button class="btn btn-primary" id="add-email-confirm">确认添加</button>
      </div>
    </div>
  </div>

  <!-- 拒绝注册申请模态框 -->
  <div id="reject-modal" class="modal">
    <div class="modal-box" style="max-width:400px;">
      <div class="modal-header">
        <span>拒绝申请</span>
        <button class="close modal-close">x</button>
      </div>
      <div class="modal-body">
        <div class="form-group">
          <label class="form-label">申请邮箱</label>
          <div id="reject-email" style="font-weight:bold;word-break:break-all;padding:8px;background:var(--bg-muted);border-radius:4px;"></div>
        </div>
        <div class="form-group">
          <label class="form-label">拒绝原因（可选）</label>
          <textarea id="reject-reason" class="form-input" rows="3" placeholder="请输入拒绝原因..."></textarea>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn modal-close">取消</button>
        <button id="reject-confirm" class="btn btn-danger">确认拒绝</button>
      </div>
    </div>
  </div>

  <script src="/js/toast-utils.js"></script>
  <script type="module" src="/js/admin.js"></script>
  <script type="module" src="/js/theme.js"></script>
</body>
</html>
